(()=>{"use strict";var e={d:(t,n)=>{for(var a in n)e.o(n,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:n[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{connect:()=>d,init:()=>l});const n=window.Automerge,a=window.peerjs;var o,c,r;class i{peer;connections=new Map;doc;afterChangeCallback;constructor(e,t,o){this.afterChangeCallback=t,this.peer=new a.Peer,this.peer.on("open",e),this.peer.on("connection",(e=>{e.peer,e.on("data",(t=>{this.receiveHandler(e,t)})),this.connections.set(e,n.initSyncState())})),this.doc=n.from(o)}changeDoc(e,t){this.doc=n.change(this.doc,e,t),this.sync()}connect(e){let t=this.peer.connect(e);t.on("open",(()=>{this.connections.set(t,n.initSyncState()),t.send({type:"SyncRequest"})})),t.on("data",(e=>{this.receiveHandler(t,e)}))}sync(){for(let[t,a]of this.connections.entries()){t.peer;let o=null;[a,o]=n.generateSyncMessage(this.doc,a),this.connections.set(t,a),o&&t.send({type:"Changes",data:(e=o,btoa(String.fromCharCode.apply(null,e)))})}var e}receiveHandler(e,t){switch(e.peer,t.type){case"Changes":t.data=new Uint8Array((a=t.data,atob(a).split("").map((function(e){return e.charCodeAt(0)}))));let o=null;[this.doc,o]=n.receiveSyncMessage(this.doc,this.connections.get(e),t.data),this.connections.set(e,o),this.sync(),this.afterChangeCallback(this.doc);break;case"SyncRequest":this.sync()}var a}}var s=!1;function l(e){o=new i(e.onOpen,f,{text:[]}),c=e.textarea,r=e.onUpdate||function(){},o.changeDoc("Update text",(e=>{c.value.split("").forEach((t=>p(e.text,t)))})),c.addEventListener("beforeinput",h),s=!0}function d(e){if(!s)throw new Error("Make sure to call init before.");if(""!=c.value)throw new Error("Ensure that the textarea is empty before connecting");o.connect(e)}function h(e){o.changeDoc("Update text",(t=>{switch(e.inputType){case"insertText":u(t.text),p(t.text,e.data);break;case"insertLineBreak":u(t.text),p(t.text,"\n");break;case"deleteContentBackward":u(t.text)||t.text.splice(c.selectionStart-1,1);break;case"deleteContentForward":u(t.text)||t.text.splice(c.selectionStart,1);break;case"insertFromPaste":u(t.text),e.data.split("").reverse().forEach((e=>p(t.text,e)))}}))}function p(e,t){let n=c.selectionStart;n<e.length?e.insertAt(n,t):e.push(t)}function u(e){return c.selectionEnd-c.selectionStart!=0&&(e.splice(c.selectionStart,c.selectionEnd-c.selectionStart),!0)}function f(e){let t=c.selectionStart,n=c.selectionEnd;c.value="",e.text.forEach((e=>{c.value+=e})),c.selectionStart=t,c.selectionEnd=n,r()}window.collaborativeTextarea=t})();